<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä»Šã®è¨˜éŒ² | é£Ÿè–¬AI</title>
    <style>
        :root { --main: #4a6741; --bg: #fdfaf1; --plus: #e8f5e9; --minus: #fff3e0; --error: #e74c3c; }
        body { font-family: "Hiragino Sans", sans-serif; background: var(--bg); padding: 15px; color: #333; line-height: 1.6; }
        .container { max-width: 550px; margin: auto; background: white; padding: 30px; border-radius: 40px; box-shadow: 0 15px 35px rgba(0,0,0,0.05); }
        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ï¼š10æ®µéšå¯¾å¿œ */
        .char-box { text-align: center; background: #f9fbf8; padding: 20px; border-radius: 30px; border: 2px solid #eef2ed; margin-bottom: 25px; }
        .char-img { font-size: 80px; display: block; }
        .char-msg { font-size: 1.2rem; font-weight: bold; color: var(--main); margin-top: 5px; }

        h1 { color: var(--main); text-align: center; font-size: 1.6rem; margin: 0 0 10px; }
        .desc { text-align: center; font-size: 0.9rem; color: #666; margin-bottom: 25px; }

        label { font-weight: bold; color: var(--main); display: block; margin: 25px 0 8px; font-size: 1.3rem; }
        select, input[type="range"] { width: 100%; padding: 18px; border-radius: 12px; border: 2px solid #eee; font-size: 1.2rem; margin-bottom: 10px; box-sizing: border-box; }
        
        /* å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼šæ’®å½±/é¸æŠä¸¡å¯¾å¿œ */
        .file-input-box { background: #f0f4ee; border: 2px dashed var(--main); padding: 25px; border-radius: 20px; text-align: center; cursor: pointer; }
        .file-input-box p { margin: 5px 0; font-weight: bold; color: var(--main); }
        input[type="file"] { display: none; } /* æœ¬ç‰©ã®ãƒœã‚¿ãƒ³ã¯éš ã—ã¦ãƒ©ãƒ™ãƒ«ã§è£…é£¾ */

        /* ç¿’æ…£ãƒã‚§ãƒƒã‚¯ï¼šåŠ ç‚¹ãƒ»æ¸›ç‚¹ã®è¦–è¦šåŒ– */
        .section-tag { font-size: 1.1rem; font-weight: bold; padding: 8px 15px; border-radius: 8px; margin-top: 30px; display: inline-block; color: white; }
        .plus-tag { background: var(--main); }
        .minus-tag { background: var(--error); }
        .q-card { display: flex; align-items: center; justify-content: space-between; padding: 18px; margin: 10px 0; border-radius: 15px; border: 1px solid #eee; }
        .q-text { flex: 1; font-size: 1.2rem; font-weight: bold; }
        .q-check { width: 40px; height: 40px; transform: scale(1.8); accent-color: var(--main); }

        .slider-label { display: flex; justify-content: space-between; font-size: 0.9rem; color: #666; margin-top: -5px; margin-bottom: 15px; }
        .btn-submit { background: var(--main); color: white; width: 100%; padding: 28px; border-radius: 20px; border: none; font-weight: bold; font-size: 1.8rem; cursor: pointer; margin-top: 40px; box-shadow: 0 10px 25px rgba(74,103,65,0.3); }

        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    </style>
</head>
<body>
    <!-- è¨ºæ–­ä¸­ã®æ¼”å‡º -->
    <div id="loading" class="loading-overlay">
        <div style="font-size: 80px;">ğŸ¦</div>
        <p style="font-weight: bold; color: #4a6741; font-size: 1.6rem; margin: 20px;">AIãŒã˜ã£ãã‚Šè¨ºå¯Ÿä¸­...</p>
        <p style="color: #666;">ï¼ˆ15ç§’ã»ã©ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰</p>
    </div>

    <div class="container">
        <div class="char-box">
            <span id="displayChar" class="char-img">ğŸ¦</span>
            <p id="displayMsg" class="char-msg">ä»Šã®ã‚ãªãŸã‚’æ•™ãˆã¦ã­ï¼</p>
        </div>

        <h1>ğŸ´ ä»Šã®é£Ÿè–¬è¨˜éŒ²</h1>
        <p class="desc">éƒ½åº¦ç™»éŒ²OKã€‚ä¸€æ—¥åˆ†ã¨ã—ã¦ç´¯è¨ˆã•ã‚Œã¾ã™ã€‚</p>

        <form id="dailyForm">
            <label>ğŸ½ï¸ ä»Šã®é£Ÿäº‹ã®ç›®çš„</label>
            <select name="meal_purpose" required>
                <option value="health">ä½“ã‚’æ•´ãˆã‚‹ï¼ˆå¥åº·ï¼‰</option>
                <option value="enjoy">æ™‚é–“ã‚’æ¥½ã—ã‚€ï¼ˆå¹¸ç¦ï¼‰</option>
                <option value="social">äººã¨éã”ã™ï¼ˆäº¤æµï¼‰</option>
            </select>

            <!-- å†™çœŸæ’®å½±/é¸æŠã‚¨ãƒªã‚¢ -->
            <label>ğŸ“¸ å†™çœŸï¼ˆé£Ÿäº‹ãƒ»èˆŒãªã©ï¼‰</label>
            <label class="file-input-box">
                <p>ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦</p>
                <p>ğŸ“· æ’®å½± ã¾ãŸã¯ ğŸ“ é¸æŠ</p>
                <!-- accept="image/*" ã«ã‚ˆã‚Šã€ã‚¹ãƒãƒ›ã§ã¯ã‚«ãƒ¡ãƒ©èµ·å‹•ã‹ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‹ã‚’é¸ã¹ã¾ã™ -->
                <input type="file" name="photos" accept="image/*" multiple required onchange="showFileCount(this)">
                <div id="fileCount" style="margin-top:10px; color:var(--main); font-weight:bold;"></div>
            </label>

            <!-- ç¿’æ…£ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¹ãƒšãƒƒã‚¯ç¶­æŒï¼‰ -->
            <div class="section-tag plus-tag">âœ¨ ä½“ã‚’æ•´ãˆã‚‹ç¿’æ…£ï¼ˆåŠ ç‚¹ï¼‰</div>
            <div id="plusQs"></div>
            <div class="section-tag minus-tag">âš ï¸ è² æ‹…ã‚’ã‹ã‘ãŸç¿’æ…£ï¼ˆæ¸›ç‚¹ï¼‰</div>
            <div id="minusQs"></div>

            <!-- ä½“èª¿ãƒ»å°¿ãƒ»ä¾¿ãƒ»ç¡çœ ï¼ˆå¾©æ´»ï¼‰ -->
            <label>ğŸŒ¡ï¸ ä»Šã®çŠ¶æ…‹ï¼ˆå„10æ®µéšï¼‰</label>
            <p style="margin: 0; font-size: 1rem; font-weight: bold;">å¿ƒã®çŠ¶æ…‹</p>
            <input type="range" name="mind_state" min="1" max="10" value="5">
            <div class="slider-label"><span>æœ€æ‚ª</span><span>æ™®é€š</span><span>æœ€é«˜</span></div>

            <p style="margin: 0; font-size: 1rem; font-weight: bold;">ä½“ã®çŠ¶æ…‹</p>
            <input type="range" name="body_state" min="1" max="10" value="5">
            <div class="slider-label"><span>æœ€æ‚ª</span><span>æ™®é€š</span><span>æœ€é«˜</span></div>

            <label>ğŸš½ æ’æ³„ãƒ»ç¡çœ ã®ãƒã‚§ãƒƒã‚¯</label>
            <select name="stool_state"><option value="è‰¯å¥½">ğŸ’© ä¾¿ã®çŠ¶æ…‹ï¼šã‚¹ãƒƒã‚­ãƒª</option><option value="ä¸èª¿">ä¾¿ã®çŠ¶æ…‹ï¼šã‚³ãƒ­ã‚³ãƒ­/ç·©ã„</option></select>
            <select name="urine_state"><option value="æ­£å¸¸">ğŸ’§ å°¿ã®è‰²ï¼šé€æ˜ã€œæ·¡é»„è‰²</option><option value="æ¿ƒã„">å°¿ã®è‰²ï¼šæ¿ƒã„ï¼ˆæ°´åˆ†ä¸è¶³ï¼‰</option></select>
            <select name="sleep_quality"><option value="è‰¯å¥½">ğŸ˜´ ç¡çœ ï¼šãã£ã™ã‚Š</option><option value="æµ…ã„">ç¡çœ ï¼šç›®ãŒè¦šã‚ãŸ/ä¸è¶³</option></select>

            <button type="submit" class="btn-submit">è¨˜éŒ²ã‚’é€ä¿¡ã—ã¦è¨ºæ–­ã¸</button>
        </form>
    </div>

    <script>
        const userId = new URLSearchParams(window.location.search).get('user_id') || "U12345";
        const charList = ["ğŸ¦","ğŸ°","ğŸ»","ğŸ¼","ğŸ¶","ğŸ±","ğŸ¨","ğŸ¢","ğŸ¥","ğŸ‘»"]; // 1:ãƒ©ã‚¤ã‚ªãƒ³ãŒæœ€å¼·

        // Q1-Q14é …ç›®ã®ç”Ÿæˆ
        const plusList = [{id:1,t:"ãƒŠãƒƒãƒ„é¡"},{id:2,t:"é‡èœ(ä¸¡æ‰‹åˆ†)"},{id:3,t:"æ—¬ã®é‡èœ"},{id:4,t:"æµ·è—»é¡"},{id:5,t:"ã‚­ãƒã‚³é¡"},{id:6,t:"ãŸã‚“ã±ãè³ª"},{id:7,t:"é­š"},{id:8,t:"å‘³å™Œæ±"},{id:9,t:"ç©ºè…¹æ„Ÿã‚ã‚Š"},{id:10,t:"ã‚ˆãå™›ã‚“ã "}];
        const minusList = [{id:11,t:"å°éº¦è£½å“"},{id:12,t:"ç”˜ã„ç‰©"},{id:13,t:"æšã’ç‰©"},{id:14,t:"ãŠé…’/ã‚«ãƒ•ã‚§ã‚¤ãƒ³"}];

        const render = (list, target, color) => {
            list.forEach(q => {
                document.getElementById(target).innerHTML += `<div class="q-card" style="background:${color}"><span class="q-text">Q${q.id}. ${q.t}ã‚’æ‘‚ã£ãŸ</span><input type="checkbox" name="Q${q.id}" class="q-check"></div>`;
            });
        };
        render(plusList, 'plusQs', '#e8f5e9'); render(minusList, 'minusQs', '#fff3e0');

        function showFileCount(input) {
            const count = input.files.length;
            document.getElementById('fileCount').innerText = count > 0 ? `${count}æšã®å†™çœŸã‚’é¸æŠä¸­` : "";
        }

        // åˆæœŸã‚­ãƒ£ãƒ©èª­ã¿è¾¼ã¿
        window.onload = async () => {
            try {
                const res = await fetch(`/.netlify/functions/get-summary?user_id=${userId}`);
                const data = await res.json();
                const level = data.char_status_logic || 1;
                document.getElementById('displayChar').innerText = charList[level-1];
            } catch(e) { console.error("Data error"); }
        };

        // é€ä¿¡å‡¦ç†ï¼ˆãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼†ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
        document.getElementById('dailyForm').onsubmit = async (e) => {
            e.preventDefault();
            document.getElementById('loading').style.display = 'flex';
            const formData = new FormData(e.target);
            formData.append('user_id', userId);

            try {
                const res = await fetch('/.netlify/functions/daily-submit', { method: 'POST', body: formData });
                if (!res.ok) throw new Error();
                const data = await res.json();
                // æˆåŠŸã—ãŸã‚‰è¨ºæ–­çµæœãƒšãƒ¼ã‚¸ã¸æ­£ã—ãç§»å‹•
                window.location.href = `/result?log_id=${data.log_id}&user_id=${userId}`;
            } catch (err) {
                document.getElementById('loading').style.display = 'none';
                alert("é€ä¿¡ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚å†™çœŸã®ç”»è³ªã‚’è½ã¨ã™ã‹ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
            }
        };
    </script>
</body>
</html>
