<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šé€±ã®ãµã‚Šè¿”ã‚Š | é£Ÿè–¬AI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #fdfaf1; padding: 15px; color: #333; line-height: 1.6; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1 { font-size: 1.2rem; text-align: center; color: #4a6741; margin-bottom: 20px; }
        .chart-area { margin-bottom: 30px; height: 250px; }
        .btn-generate { background: #4a6741; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .advice-box { display: none; margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
        .card { background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 15px; font-size: 0.9rem; }
        .card strong { color: #4a6741; display: block; margin-bottom: 5px; border-bottom: 1px solid #ddd; }
        .loading { text-align: center; color: #888; font-size: 0.8rem; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ä»Šé€±ã®ç©ã¿é‡ã­</h1>
        
        <!-- 1. ç´¯ç©ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
        <div class="chart-area"><canvas id="weeklyChart"></canvas></div>

        <!-- 2. ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆãƒœã‚¿ãƒ³ -->
        <button class="btn-generate" id="genBtn" onclick="generateWeeklyPlan()">æ¥é€±ã®é£Ÿè–¬å‡¦æ–¹ç®‹ã‚’å—ã‘å–ã‚‹</button>
        <div id="loader" class="loading" style="display:none;">AIãŒæ¥é€±ã®çŒ®ç«‹ã¨ãƒ¬ã‚·ãƒ”ã‚’è€ƒæ¡ˆä¸­...<br>(30ç§’ã»ã©ã‹ã‹ã‚Šã¾ã™)</div>

        <!-- 3. AIã‚¢ãƒ‰ãƒã‚¤ã‚¹è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="aiAdviceArea" class="advice-box">
            <div class="card"><strong>ğŸ“‹ æ¥é€±ã®ãŠã™ã™ã‚çŒ®ç«‹</strong><ul id="menuList"></ul></div>
            <div class="card"><strong>ğŸ›’ ãŠè²·ã„ç‰©ãƒªã‚¹ãƒˆ</strong><p id="shoppingList"></p></div>
            <div class="card"><strong>ğŸ³ ç°¡å˜ãƒ¬ã‚·ãƒ”ï¼š<span id="recipeName"></span></strong>
                <p id="recipeIngredients" style="font-size:0.8rem; color:#666;"></p>
                <p id="recipeSteps"></p>
            </div>
            <div class="card"><strong>ğŸ’¡ é£Ÿè–¬ã‚¢ãƒ‰ãƒã‚¤ã‚¹</strong><p id="totalAdvice"></p></div>
        </div>
    </div>

    <script>
        const userId = "U12345"; // é‹ç”¨ã«åˆã‚ã›ã¦å‹•çš„ã«å–å¾—ã™ã‚‹ã‚ˆã†å¤‰æ›´å¯èƒ½

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚°ãƒ©ãƒ•ã‚’æç”»
        window.onload = async () => {
            const res = await fetch(`/.netlify/functions/get-summary?user_id=${userId}`);
            const data = await res.json();
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['ã“ã‚Œã¾ã§ã®å¹³å‡', 'ä»Šé€±ã®ã‚ãªãŸ'],
                    datasets: [
                        { label: 'ç©ã¿é‡ã­', data: [data.base_avg_all, data.base_avg_all], borderColor: '#ccc', borderDash: [1], fill: false },
                        { label: 'ä»Šé€±', data: [null, data.base_avg_7d], borderColor: '#ff6384', backgroundColor: '#ff6384', pointRadius: 8, fill: false }
                    ]
                },
                options: { scales: { y: { min: 0, max: 100 } } }
            });
        };

        // AIãƒ—ãƒ©ãƒ³ç”ŸæˆAPIã®å‘¼ã³å‡ºã— [2]
        async function generateWeeklyPlan() {
            document.getElementById('genBtn').style.display = 'none';
            document.getElementById('loader').style.display = 'block';

            try {
                const res = await fetch(`/.netlify/functions/weekly-generate?user_id=${userId}`);
                const plan = await res.json();

                // ç”»é¢ã¸ã®åæ˜ 
                document.getElementById('aiAdviceArea').style.display = 'block';
                document.getElementById('loader').style.display = 'none';
                
                // çŒ®ç«‹ãƒªã‚¹ãƒˆ
                const menuList = document.getElementById('menuList');
                plan.é£Ÿè–¬çŒ®ç«‹.forEach(m => { const li = document.createElement('li'); li.innerText = m; menuList.appendChild(li); });
                
                document.getElementById('shoppingList').innerText = plan.è²·ã„ç‰©ãƒªã‚¹ãƒˆ.join('ã€');
                document.getElementById('recipeName').innerText = plan.ç°¡å˜é£Ÿè–¬ãƒ¬ã‚·ãƒ”.æ–™ç†å;
                document.getElementById('recipeIngredients').innerText = "ææ–™ï¼š" + plan.ç°¡å˜é£Ÿè–¬ãƒ¬ã‚·ãƒ”.ææ–™.join(', ');
                document.getElementById('recipeSteps').innerText = plan.ç°¡å˜é£Ÿè–¬ãƒ¬ã‚·ãƒ”.ä½œã‚Šæ–¹.join(' â†’ ');
                document.getElementById('totalAdvice').innerText = plan.é£Ÿè–¬ã‚¢ãƒ‰ãƒã‚¤ã‚¹;

            } catch (err) {
                alert("ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
            }
        }
    </script>
</body>
</html>
